---
import fs from "node:fs";
import path from "node:path";

interface Speaker {
    name: string;
    photoPath: string;
    title: string;
    description: string;
    website?: string;
}

const tsvPath = path.join(process.cwd(), "src/data/speakers.tsv");
const tsvContent = fs.readFileSync(tsvPath, "utf-8");

const lines = tsvContent.split("\n");
const dataLines = lines.slice(3).filter((line) => line.trim() !== "");

function parseTsvValue(value: string): string {
    if (value.startsWith('"') && value.endsWith('"')) {
        return value.slice(1, -1);
    }
    return value;
}

function toSlug(name: string): string {
    return name
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-/, "")
        .replace(/-$/, "");
}

function getExtension(url: string): string {
    const match = url.match(/\.(\w+)$/);
    return match ? match[1] : "jpg";
}

const speakers: Speaker[] = dataLines
    .map((line) => {
        const parts = line.split("\t");
        const name = parseTsvValue(parts[0] || "");
        const photoUrl = parseTsvValue(parts[2] || "");
        const extension = getExtension(photoUrl);
        return {
            name,
            photoPath: `/speakers/${toSlug(name)}.${extension}`,
            title: parseTsvValue(parts[4] || ""),
            description: parseTsvValue(parts[5] || ""),
            website: parseTsvValue(parts[6] || ""),
        };
    })
    .filter((s) => s.name && s.title);
---

<section class="speakers">
    <div class="speakers-header">
        <h2>Intervenants</h2>
        <button
            class="general-card-btn"
            type="button"
            title="Télécharger l'affiche générale"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Affiche générale
        </button>
    </div>
    <script id="speakers-data" type="application/json" set:html={JSON.stringify(speakers.map(s => ({ name: s.name, title: s.title })))} />
    <div class="speakers-grid">
        {
            speakers.map((speaker) => {
                const needsTruncation = speaker.description.length > 240;
                const truncated = needsTruncation
                    ? speaker.description.slice(0, 240).trimEnd() + "…"
                    : speaker.description;
                return (
                    <article class="speaker-card">
                        <button
                            class="share-btn"
                            type="button"
                            title="Télécharger une image de partage"
                            data-name={speaker.name}
                            data-title={speaker.title}
                            data-photo={speaker.photoPath}
                            data-description={speaker.description}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </button>
                        {speaker.photoPath.length ? (
                            <img
                                src={speaker.photoPath}
                                alt={`Photo de ${speaker.name}`}
                                class="speaker-photo"
                                loading="lazy"
                            />
                        ) : (
                            <div />
                        )}

                        <div class="speaker-info">
                            <h3>{speaker.name}</h3>
                            {speaker.website ? <h5 style="font-size: 0.65rem"><a href={speaker.website} target="_blank">{speaker.website}</a></h5> : <div/> }
                            <h4>{speaker.title}</h4>
                            <p
                                class="description"
                                data-full={speaker.description}
                                data-truncated={truncated}
                            >
                                {truncated}
                            </p>
                            {needsTruncation && (
                                <button class="expand-btn" type="button">
                                    Lire la suite
                                </button>
                            )}
                        </div>
                    </article>
                );
            })
        }
    </div>
</section>

<script>
    document.querySelectorAll(".expand-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            const description = btn.previousElementSibling as HTMLElement;
            const isExpanded = btn.getAttribute("data-expanded") === "true";

            if (isExpanded) {
                description.textContent = description.dataset.truncated!;
                btn.textContent = "Lire la suite";
                btn.setAttribute("data-expanded", "false");
            } else {
                description.textContent = description.dataset.full!;
                btn.textContent = "Réduire";
                btn.setAttribute("data-expanded", "true");
            }
        });
    });

    const CARD_SIZE = 1080;
    const EVENT_URL = "table-ronde-optique-amateur.fr";
    const EVENT_DATE = "4-5 mars 2026";

    function loadImage(src: string): Promise<HTMLImageElement> {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = src;
        });
    }

    function wrapText(ctx: CanvasRenderingContext2D, text: string, maxWidth: number): string[] {
        const words = text.split(" ");
        const lines: string[] = [];
        let currentLine = "";

        for (const word of words) {
            const testLine = currentLine ? `${currentLine} ${word}` : word;
            const metrics = ctx.measureText(testLine);
            if (metrics.width > maxWidth && currentLine) {
                lines.push(currentLine);
                currentLine = word;
            } else {
                currentLine = testLine;
            }
        }
        if (currentLine) {
            lines.push(currentLine);
        }
        return lines;
    }

    async function generateShareCard(name: string, title: string, photoSrc: string, description: string) {
        const canvas = document.createElement("canvas");
        canvas.width = CARD_SIZE;
        canvas.height = CARD_SIZE;
        const ctx = canvas.getContext("2d")!;

        const bgImage = await loadImage("/optics.jpg");
        const bgMin = Math.min(bgImage.width, bgImage.height);
        const sx = (bgImage.width - bgMin) / 2;
        const sy = (bgImage.height - bgMin) / 2;
        ctx.drawImage(bgImage, sx, sy, bgMin, bgMin, 0, 0, CARD_SIZE, CARD_SIZE);

        ctx.fillStyle = "rgba(0, 0, 0, 0.65)";
        ctx.fillRect(0, 0, CARD_SIZE, CARD_SIZE);

        const photoSize = 200;
        const photoX = (CARD_SIZE - photoSize) / 2;
        const photoY = 80;

        if (photoSrc) {
            try {
                const photo = await loadImage(photoSrc);
                ctx.save();
                ctx.beginPath();
                ctx.arc(photoX + photoSize / 2, photoY + photoSize / 2, photoSize / 2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                const srcSize = Math.min(photo.width, photo.height);
                const srcX = (photo.width - srcSize) / 2;
                const srcY = (photo.height - srcSize) / 2;
                ctx.drawImage(photo, srcX, srcY, srcSize, srcSize, photoX, photoY, photoSize, photoSize);
                ctx.restore();

                ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(photoX + photoSize / 2, photoY + photoSize / 2, photoSize / 2, 0, Math.PI * 2);
                ctx.stroke();
            } catch {
            }
        }

        const padding = 60;
        const textMaxWidth = CARD_SIZE - padding * 2;

        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 64px system-ui, -apple-system, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(name, CARD_SIZE / 2, photoY + photoSize + 80);

        ctx.fillStyle = "rgba(100, 200, 150, 0.95)";
        ctx.font = "italic 48px system-ui, -apple-system, sans-serif";
        const titleLines = wrapText(ctx, title, textMaxWidth);
        let titleY = photoY + photoSize + 150;
        for (const line of titleLines.slice(0, 2)) {
            ctx.fillText(line, CARD_SIZE / 2, titleY);
            titleY += 58;
        }

        if (description) {
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            ctx.font = "36px system-ui, -apple-system, sans-serif";
            const descLines = wrapText(ctx, description, textMaxWidth);
            const maxLines = 5;
            let descY = titleY + 40;
            const linesToShow = descLines.slice(0, maxLines);
            for (let i = 0; i < linesToShow.length; i++) {
                let line = linesToShow[i];
                if (i === maxLines - 1 && descLines.length > maxLines) {
                    line = line.trimEnd() + " [...]";
                }
                ctx.fillText(line, CARD_SIZE / 2, descY);
                descY += 46;
            }
        }

        ctx.fillStyle = "rgba(100, 200, 150, 0.9)";
        ctx.font = "600 48px system-ui, -apple-system, sans-serif";
        ctx.fillText(EVENT_DATE, CARD_SIZE / 2, CARD_SIZE - 110);

        ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
        ctx.font = "42px system-ui, -apple-system, sans-serif";
        ctx.fillText(EVENT_URL, CARD_SIZE / 2, CARD_SIZE - 55);

        ctx.fillStyle = "rgba(255, 255, 255, 0.35)";
        ctx.font = "20px system-ui, -apple-system, sans-serif";
        ctx.textAlign = "right";
        ctx.fillText("Isabel Llorente Garcia / Wikimedia Commons", CARD_SIZE - 20, CARD_SIZE - 18);

        const link = document.createElement("a");
        link.download = `${name.toLowerCase().replace(/[^a-z0-9]/g, "-")}-table-ronde-optique.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    document.querySelectorAll(".share-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
            e.preventDefault();
            const button = btn as HTMLElement;
            const name = button.dataset.name || "";
            const title = button.dataset.title || "";
            const photo = button.dataset.photo || "";
            const description = button.dataset.description || "";

            button.style.opacity = "0.5";
            button.style.pointerEvents = "none";

            try {
                await generateShareCard(name, title, photo, description);
            } catch (err) {
                console.error("Failed to generate share card:", err);
                alert("Erreur lors de la génération de l'image");
            } finally {
                button.style.opacity = "";
                button.style.pointerEvents = "";
            }
        });
    });

    async function generateGeneralCard(talks: { name: string; title: string }[]) {
        const S = 2;
        const W = 1200 * S;
        const H = 630 * S;
        const canvas = document.createElement("canvas");
        canvas.width = W;
        canvas.height = H;
        const ctx = canvas.getContext("2d")!;

        const bgImage = await loadImage("/optics.jpg");
        const bgAspect = bgImage.width / bgImage.height;
        const targetAspect = W / H;
        let sw: number, sh: number, sx: number, sy: number;
        if (bgAspect > targetAspect) {
            sh = bgImage.height;
            sw = sh * targetAspect;
            sx = (bgImage.width - sw) / 2;
            sy = 0;
        } else {
            sw = bgImage.width;
            sh = sw / targetAspect;
            sx = 0;
            sy = (bgImage.height - sh) / 2;
        }
        ctx.drawImage(bgImage, sx, sy, sw, sh, 0, 0, W, H);

        ctx.fillStyle = "rgba(0, 0, 0, 0.65)";
        ctx.fillRect(0, 0, W, H);

        const leftPadding = 50 * S;
        const leftColWidth = 420 * S;
        const rightX = leftPadding + leftColWidth + 40 * S;
        const rightColWidth = W - rightX - 40 * S;

        ctx.textAlign = "left";

        ctx.fillStyle = "#ffffff";
        ctx.font = `bold ${42 * S}px system-ui, -apple-system, sans-serif`;
        const headingLines = wrapText(ctx, "Table ronde optique amateur", leftColWidth);
        let headingY = 100 * S;
        for (const line of headingLines) {
            ctx.fillText(line, leftPadding, headingY);
            headingY += 50 * S;
        }

        ctx.fillStyle = "rgba(100, 200, 150, 0.9)";
        ctx.font = `600 ${36 * S}px system-ui, -apple-system, sans-serif`;
        ctx.fillText(EVENT_DATE, leftPadding, headingY + 20 * S);

        ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
        ctx.font = `${28 * S}px system-ui, -apple-system, sans-serif`;
        ctx.fillText(EVENT_URL, leftPadding, headingY + 60 * S);

        const listTop = 70 * S;
        const listBottom = H - 50 * S;
        const availableHeight = listBottom - listTop;

        function measureLayout(titleFontSize: number) {
            const nameFontSize = Math.floor(titleFontSize * 0.72);
            const titleLH = Math.floor(titleFontSize * 1.3);
            const nameLH = Math.floor(nameFontSize * 1.3);
            const gap = Math.floor(titleFontSize * 0.35);
            let total = 0;
            const entries: { titleLines: string[]; name: string }[] = [];
            for (const talk of talks) {
                ctx.font = `${titleFontSize}px system-ui, -apple-system, sans-serif`;
                const titleLines = wrapText(ctx, `\u2022 ${talk.title}`, rightColWidth);
                entries.push({ titleLines, name: talk.name });
                total += titleLines.length * titleLH + nameLH + gap;
            }
            total -= gap;
            return { entries, titleFontSize, nameFontSize, titleLH, nameLH, gap, total };
        }

        let titleSize = 26 * S;
        let layout = measureLayout(titleSize);
        while (layout.total > availableHeight && titleSize > 14 * S) {
            titleSize -= 1;
            layout = measureLayout(titleSize);
        }

        let y = listTop;
        for (const entry of layout.entries) {
            ctx.font = `${layout.titleFontSize}px system-ui, -apple-system, sans-serif`;
            ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
            for (const line of entry.titleLines) {
                ctx.fillText(line, rightX, y);
                y += layout.titleLH;
            }

            ctx.font = `${layout.nameFontSize}px system-ui, -apple-system, sans-serif`;
            ctx.fillStyle = "rgba(100, 200, 150, 0.8)";
            ctx.fillText(entry.name, rightX + 16 * S, y);
            y += layout.nameLH + layout.gap;
        }

        ctx.fillStyle = "rgba(255, 255, 255, 0.35)";
        ctx.font = `${14 * S}px system-ui, -apple-system, sans-serif`;
        ctx.textAlign = "right";
        ctx.fillText("Isabel Llorente Garcia / Wikimedia Commons", W - 14 * S, H - 12 * S);

        const link = document.createElement("a");
        link.download = "table-ronde-optique-amateur-affiche.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    const generalBtn = document.querySelector(".general-card-btn");
    if (generalBtn) {
        generalBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            const btn = generalBtn as HTMLElement;
            btn.style.opacity = "0.5";
            btn.style.pointerEvents = "none";

            try {
                const dataEl = document.getElementById("speakers-data");
                const talks: { name: string; title: string }[] = dataEl ? JSON.parse(dataEl.textContent || "[]") : [];
                await generateGeneralCard(talks);
            } catch (err) {
                console.error("Failed to generate general card:", err);
                alert("Erreur lors de la génération de l'affiche");
            } finally {
                btn.style.opacity = "";
                btn.style.pointerEvents = "";
            }
        });
    }
</script>

<style>
    .speakers {
        margin: 2rem 0;
        width: 100vw;
        margin-left: calc(50% - 50vw);
        padding: 2rem 1rem;
        box-sizing: border-box;
    }

    .speakers-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        max-width: 1200px;
        margin: 0 auto 1.5rem;
    }

    .speakers h2 {
        margin: 0;
    }

    .general-card-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.75rem;
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid #ddd;
        border-radius: 6px;
        color: #555;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
        white-space: nowrap;
    }

    .general-card-btn:hover {
        background: rgba(0, 0, 0, 0.1);
        color: #333;
    }

    .speakers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .speaker-card {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 0.75rem;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
    }

    .share-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 6px;
        color: #666;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
    }

    .share-btn:hover {
        background: rgba(0, 0, 0, 0.1);
        color: #333;
    }

    .speaker-photo {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .speaker-info h3 {
        margin: 0 0 0.5rem 0;
    }

    .speaker-info h4 {
        margin: 0 0 0.5rem 0;
        color: #555;
        font-weight: normal;
        font-style: italic;
    }

    .speaker-info p {
        margin: 0;
        font-size: 0.875rem;
        line-height: 1.4;
    }

    .expand-btn {
        margin-top: 0.5rem;
        padding: 0;
        background: none;
        border: none;
        color: var(--accent, #4a90d9);
        cursor: pointer;
        font-size: 0.9rem;
    }

    .expand-btn:hover {
        text-decoration: underline;
    }

    @media (max-width: 600px) {
        .speakers-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .speaker-card {
            padding: 1rem;
        }

        .speaker-photo {
            width: 100px;
            height: 100px;
        }
    }
</style>
