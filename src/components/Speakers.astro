---
import fs from "node:fs";
import path from "node:path";

interface Speaker {
    name: string;
    photoPath: string;
    title: string;
    description: string;
}

const tsvPath = path.join(process.cwd(), "src/data/speakers.tsv");
const tsvContent = fs.readFileSync(tsvPath, "utf-8");

const lines = tsvContent.split("\n");
const dataLines = lines.slice(3).filter((line) => line.trim() !== "");

function parseTsvValue(value: string): string {
    if (value.startsWith('"') && value.endsWith('"')) {
        return value.slice(1, -1);
    }
    return value;
}

function toSlug(name: string): string {
    return name
        .toLowerCase()
        .replace(/[^a-z0-9]/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-/, "")
        .replace(/-$/, "");
}

function getExtension(url: string): string {
    const match = url.match(/\.(\w+)$/);
    return match ? match[1] : "jpg";
}

const speakers: Speaker[] = dataLines.map((line) => {
    const parts = line.split("\t");
    const name = parseTsvValue(parts[0] || "");
    const photoUrl = parseTsvValue(parts[2] || "");
    const extension = getExtension(photoUrl);
    return {
        name,
        photoPath: `/speakers/${toSlug(name)}.${extension}`,
        title: parseTsvValue(parts[4] || ""),
        description: parseTsvValue(parts[5] || ""),
    };
}).filter((s) => s.name && s.title);
---

<section class="speakers">
    <h2>Intervenants</h2>
    <div class="speakers-grid">
        {speakers.map((speaker) => {
            const needsTruncation = speaker.description.length > 240;
            const truncated = needsTruncation
                ? speaker.description.slice(0, 240).trimEnd() + "…"
                : speaker.description;
            return (
                <article class="speaker-card">
                    <img
                        src={speaker.photoPath}
                        alt={`Photo de ${speaker.name}`}
                        class="speaker-photo"
                        loading="lazy"
                    />
                    <div class="speaker-info">
                        <h3>{speaker.name}</h3>
                        <h4>{speaker.title}</h4>
                        <p class="description" data-full={speaker.description} data-truncated={truncated}>
                            {truncated}
                        </p>
                        {needsTruncation && (
                            <button class="expand-btn" type="button">Lire la suite</button>
                        )}
                    </div>
                </article>
            );
        })}
    </div>
</section>

<script>
    document.querySelectorAll('.expand-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const description = btn.previousElementSibling as HTMLElement;
            const isExpanded = btn.getAttribute('data-expanded') === 'true';

            if (isExpanded) {
                description.textContent = description.dataset.truncated!;
                btn.textContent = 'Lire la suite';
                btn.setAttribute('data-expanded', 'false');
            } else {
                description.textContent = description.dataset.full!;
                btn.textContent = 'Réduire';
                btn.setAttribute('data-expanded', 'true');
            }
        });
    });
</script>

<style>
    .speakers {
        margin: 2rem 0;
    }

    .speakers h2 {
        margin-bottom: 1.5rem;
    }

    .speakers-grid {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .speaker-card {
        display: flex;
        gap: 1.5rem;
        padding: 1.5rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
    }

    .speaker-photo {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .speaker-info h3 {
        margin: 0 0 0.5rem 0;
    }

    .speaker-info h4 {
        margin: 0 0 1rem 0;
        color: #555;
        font-weight: normal;
        font-style: italic;
    }

    .speaker-info p {
        margin: 0;
        line-height: 1.6;
    }

    .expand-btn {
        margin-top: 0.5rem;
        padding: 0;
        background: none;
        border: none;
        color: var(--accent, #4a90d9);
        cursor: pointer;
        font-size: 0.9rem;
    }

    .expand-btn:hover {
        text-decoration: underline;
    }

    @media (max-width: 600px) {
        .speakers-grid {
            gap: 1rem;
        }

        .speaker-card {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1rem;
            gap: 1rem;
        }

        .speaker-photo {
            width: 80px;
            height: 80px;
        }
    }
</style>
